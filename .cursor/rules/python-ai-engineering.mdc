---
description: General Python AI engineering standards for this project
globs: srv/**/*.py
alwaysApply: false
---

# Python AI Engineering Standards

## Type Safety — Always Use Type Hints

```python
# ❌ BAD
def __init__(self, llm, tools=None):
    ...

# ✅ GOOD
from langchain_openai import ChatOpenAI
from langchain_core.tools import BaseTool

def __init__(self, llm: ChatOpenAI, tools: list[BaseTool] | None = None) -> None:
    ...
```

Use `TypedDict` for state schemas and Pydantic models for external data / response formats.

## LLM Settings for Tool Use

```python
# ❌ temperature > 0 leads to unpredictable tool calls
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)

# ✅ Always 0 for tool-calling agents
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
```

## Use Batch for Multiple Independent Calls

```python
# ❌ Sequential — slower
for query in queries:
    result = llm.invoke(query)

# ✅ Parallel via batch
results = llm.batch(queries)
```

## Async by Default in FastAPI

All I/O-bound operations (LLM calls, HTTP, DB) must be `async`:

```python
# ❌ Blocks the event loop
def select_element(self, query: str) -> dict:
    return self.agent.invoke({"messages": [...]})

# ✅
async def select_element(self, query: str) -> dict:
    return await self.agent.ainvoke({"messages": [...]})
```

## Error Handling — Never Swallow Errors

```python
# ❌ Silent failure
try:
    result = await agent.ainvoke(state)
except Exception:
    pass

# ✅ Log, wrap, re-raise
import logging
logger = logging.getLogger(__name__)

try:
    result = await agent.ainvoke(state)
except Exception as e:
    logger.error("Agent invocation failed", exc_info=True)
    raise AgentError("Failed to process request") from e
```

## Dependency Management

Use `uv` for all package operations:

```bash
uv add langchain langchain-openai langgraph
uv add --dev pytest pytest-asyncio pytest-mock ruff
```

Pin major versions in `pyproject.toml`. Never use `pip install` directly in the project.

## Environment Variables

All secrets and config come from environment variables. Never hardcode API keys.
Use package-prefixed env vars: `OPENAI_API_KEY`, `ACMESTORE_BASE_URL`, `AGENT_LLM_MODEL`, etc.

## Code Quality

- Format with `ruff format`, lint with `ruff check`
- Run `just lint-srv` before committing
- No `print()` in production code — use `logging`
